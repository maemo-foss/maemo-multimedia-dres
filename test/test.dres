# -*- makefile -*-

PREFIX = dres.test

$fact1 = { name: 'fact1', value: '1' }
$fact2 = { name: 'fact2', value: '2' }
$fact3 = { name: 'fact3', value: '3' }
$fact4 = { name: 'fact4', value: '4' }
$fact5 = { name: 'fact5', value: '5' }


all: test1
	echo('all done')

test1: touch1 fact1
	echo('checking test1...')
	check(fact4, stamp, '1')
	check(fact3, stamp, '2')
	check(fact2, stamp, '3')
	check(fact1, stamp, '4')
	echo('test1 OK')

touch1:
	echo('actions for touch1...')
	stamp(101)
	touch(fact1)
	touch(fact2)
	touch(fact3)
	touch(fact4)
	stamp(1)

test2: touch2 fact3
	echo('checking test2...')
	check(fact2, stamp, '201')
	check(fact4, stamp, '1')
	check(fact3, stamp, '2')
	echo('test2 OK')
	echo('recursing for test2 with "all"...')
	dres(all)


testrec1: fact1
	echo(testrec1)
	echo(recursing)
	dres(testrec2)
	echo(testrec1done)

testrec2: fact2
	echo(testrec2)
	echo(gonnafail)
	fail()
	echo(testrec2done)

testrecursefail: touch2 testrec1
	echo(checking2)
	dres(all)

touch2:
	echo(touch2)
	stamp(201)
	touch(fact2)
	touch(fact3)
	touch(fact4)
	stamp(1)

test3: touch3 fact5
	echo(checking3)
	check(fact1, stamp, '201')
	check(fact2, stamp, '202')
	check(fact4, stamp, '1')
	check(fact3, stamp, '2')
	echo(test3OK)

touch3:
	echo('actions for touch3...')
	stamp(301)
	touch(fact1)
	touch(fact2)
	touch(fact3)
	touch(fact4)
	stamp(1)

fact1: fact2
	echo('actions for fact1...')
	$fact1 = fact(fact1, value, foo1)

fact2: fact3
	echo('actions for fact2...')
	$fact2 = fact(fact2, value, foo2)

fact3: fact4
	echo('actions for fact3...')
	$fact3 = fact(fact3, value, foo3)

fact4:
	echo('actions for fact4...')
	$dres.test.fact4 = fact(fact4, value, foo4)

fact5: fact1
	echo('actions for fact5...')
	$fact5 = fact(fact5, value, foo4)
	echo('forcing failure...')
	fail()

fail: fact1
	echo('forcing failure...')
	fail()
